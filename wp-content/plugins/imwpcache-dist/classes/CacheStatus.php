<?php
 namespace imwpcache\classes; class CacheStatus { public function run() { add_action('admin_init', array($this, 'show')); add_action('wp_ajax_reload_cache', array($this, 'reloadCache')); } public function show() { add_filter('manage_posts_columns', array($this, 'addColumn')); add_action('manage_posts_custom_column', array($this, 'addValue'), 10, 2); add_filter('manage_pages_columns', array($this, 'addColumn')); add_action('manage_pages_custom_column', array($this, 'addValue'), 10, 2); foreach (get_taxonomies() as $taxonomy) { add_action("manage_edit-${taxonomy}_columns", array($this, 'addColumn')); add_filter("manage_${taxonomy}_custom_column", array($this, 'addReturnValue'), 10, 3); } } public function addColumn($cols) { $cols['imwpcache'] = '缓存'; return $cols; } public function addValue($columnName, $id) { if ($columnName == 'imwpcache') { $value = ""; if (false !== $cache = CacheLoader::load()) { $link = get_permalink($id); $key = md5('pc' . $link); if ($cache->exists($key)) { $value .= "<span style='color:green'>已缓存</span>"; } else { $value .= "<span style='color:red'>未缓存</span>"; } } $adminAjax = admin_url("admin-ajax.php"); $value .= " | <a href='{$adminAjax}?action=reload_cache&post_id={$id}' target='_blank'>重新生成</a>"; echo $value; } } public function addReturnValue($value, $columnName, $id) { if ($columnName == 'imwpcache') { $value = ""; if (false !== $cache = CacheLoader::load()) { $link = get_category_link($id); $key = md5('pc' . $link); if ($cache->exists($key)) { $value .= "<span style='color:green'>已缓存</span>"; } else { $value .= "<span style='color:red'>未缓存</span>"; } } $adminAjax = admin_url("admin-ajax.php"); $value .= " | <a href='{$adminAjax}?action=reload_cache&cat_id={$id}' target='_blank'>重新生成</a>"; return $value; } return $value; } public function reloadCache() { if (!empty($_GET['post_id'])) { $url = get_permalink(intval($_GET['post_id'])); $result = \imwpf\modules\HTTP::post($url, array('reload_cache' => 1), 30); if (strpos($result, '<!--statusok-->') !== false) { echo "缓存生成成功"; } else { echo "缓存生成失败"; } } if (!empty($_GET['cat_id'])) { $url = get_category_link(intval($_GET['cat_id'])); $result = \imwpf\modules\HTTP::post($url, array('reload_cache' => 1), 30); if (strpos($result, '<!--statusok-->') !== false) { echo "缓存生成成功"; } else { echo "缓存生成失败"; } } die(); } } 