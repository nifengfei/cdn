<?php
 namespace imwpf\apis; use imwpf\modules; use imwpf\admin\Options; class Weixin { public function start() { add_action('wp_ajax_imwpf_weixin', array($this, 'receive')); add_action('wp_ajax_nopriv_imwpf_weixin', array($this, 'receive')); } public function receive() { $wx = new modules\Weixin(); $opt = Options::getInstance('imwpf_options')->get('weixin'); $wx->setToken($opt['token']); $ok = $wx->checkSignature(modules\Input::str('signature'), modules\Input::int('timestamp'), modules\Input::str('nonce')); if (!$ok) { echo "error"; die(); } if ("" !== $echostr = modules\Input::str('echostr')) { echo $echostr; die(); } $postData = file_get_contents("php://input"); $msg = simplexml_load_string($postData); $content = $wx->getResponse($msg); echo $wx->sendMessage($msg->FromUserName, $msg->ToUserName, $content); die(); } }